<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>직원 관리 정보</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css" />
    <!-- Supabase JS 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- 스크립트 파일 -->
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    
  </head>
  <body>
    <!-- 로딩 오버레이 -->
    <div id="loadingOverlay">
      <div class="loader"></div>
      <div>데이터를 처리중입니다...</div>
    </div>

    <div class="container">
      <!-- 헤더 부분 -->
      <div class="header" id="headerSection">
        <div class="title" id="pageTitle">
          우리집 데이케어 센터 관리자모드_PW부여
        </div>
      </div>

      <div class="content-wrapper" id="contentArea">
        <div class="employee-list" id="employeeListContainer">
          <h3 class="employee-list-title" id="employeeListTitle">직원 목록</h3>
          <div class="table-container">
            <table id="employeeTable">
              <thead>
                <tr>
                  <th class="employee-column">직원번호</th>
                  <th class="employee-column">직원명</th>
                  <th class="employee-column">비밀번호</th>
                </tr>
              </thead>
              <tbody id="employeeTableBody">
                <!-- 데이터는 JavaScript로 동적 생성 -->
              </tbody>
            </table>
          </div>
        </div>

        <div class="employee-form" id="employeeFormContainer">
          <h3>직원 정보</h3>
          <form id="employeeForm" onsubmit="return false;">
            <div class="form-group">
              <label for="employeeId">직원번호</label>
              <div class="input-with-button">
                <input type="text" id="employeeId" name="employeeId" readonly />
                <button type="button" id="searchEmployeeBtn">검색</button>
              </div>
            </div>
            <div class="form-group">
              <label for="employeeName">직원명</label>
              <input type="text" id="employeeName" name="employeeName" />
            </div>
            <div class="form-group">
              <label for="employeePassword">비밀번호</label>
              <input
                type="password"
                id="employeePassword"
                name="employeePassword"
                minlength="6"
                placeholder="비밀번호는 최소 6자리 이상"
              />
              <div class="password-hint">
                * 비밀번호는 최소 6자리 이상 입력해주세요
              </div>
            </div>
            <div class="form-buttons">
              <button type="button" id="saveBtn">저장</button>
              <button type="button" id="updateBtn">수정</button>
              <button type="button" id="deleteBtn">삭제</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- 모달 컴포넌트 -->
    <div class="modal-overlay" id="customModal">
      <div class="modal-container">
        <div class="modal-header">
          <div class="modal-title">알림</div>
          <div class="modal-close">&times;</div>
        </div>
        <div class="modal-body" id="modalMessage">
          <!-- 메시지 내용이 여기에 들어갑니다 -->
        </div>
        <div class="modal-footer">
          <button class="modal-btn" id="modalConfirmBtn">확인</button>
        </div>
      </div>
    </div>

    <!-- 확인 모달 -->
    <div class="modal-overlay" id="confirmModal">
      <div class="modal-container">
        <div class="modal-header">
          <div class="modal-title">확인</div>
          <div class="modal-close">&times;</div>
        </div>
        <div class="modal-body" id="confirmModalMessage">
          <!-- 메시지 내용이 여기에 들어갑니다 -->
        </div>
        <div class="modal-footer">
          <button class="modal-btn" id="confirmYesBtn">확인</button>
          <button class="modal-btn cancel-btn" id="confirmNoBtn">취소</button>
        </div>
      </div>
    </div>

    <!-- 직원 검색 모달 -->
    <div class="modal-overlay" id="employeeSearchModal">
      <div class="modal-container search-modal-container">
        <div class="modal-header">
          <div class="modal-title">직원 검색</div>
          <div class="modal-close">&times;</div>
        </div>
        <div class="modal-body">
          <div class="search-box">
            <input
              type="text"
              id="employeeSearchInput"
              placeholder="직원번호 또는 이름 검색"
            />
          </div>
          <div class="search-results">
            <table id="employeeSearchTable">
              <thead>
                <tr>
                  <th>직원번호</th>
                  <th>직원명</th>
                </tr>
              </thead>
              <tbody id="employeeSearchTableBody">
                <!-- 검색 결과가 여기에 표시됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let all_employeesinfo = null;

      // Supabase 인증 관련 기능을 관리하는 스크립트

      // 페이지 로드 시 실행
      document.addEventListener("DOMContentLoaded", async function () {
        // 직원 정보 로드
        try {
          showLoading();
          all_employeesinfo = await getEmployeesInfo();
          console.log("직원 정보 로드 완료:", all_employeesinfo);

          // 직원 정보 로드 후 직원 목록 초기화
          await initEmployeeList();

          hideLoading();
        } catch (error) {
          console.error("직원 정보 로드 중 오류:", error);
          hideLoading();
          showAlert("직원 정보 로드에 실패했습니다.");
        }

        // 직원 검색 버튼 이벤트 설정
        const searchEmployeeBtn = document.getElementById("searchEmployeeBtn");
        if (searchEmployeeBtn) {
          searchEmployeeBtn.addEventListener("click", openEmployeeSearchModal);
        }

        // 직원 검색 입력 필드 이벤트 설정
        const employeeSearchInput = document.getElementById(
          "employeeSearchInput"
        );
        if (employeeSearchInput) {
          employeeSearchInput.addEventListener(
            "input",
            filterEmployeeSearchResults
          );
        }

        // 삭제 버튼 이벤트 설정
        const deleteBtn = document.getElementById("deleteBtn");
        if (deleteBtn) {
          deleteBtn.addEventListener("click", deleteEmployee);
        }

        // 저장 버튼 이벤트 설정
        const saveBtn = document.getElementById("saveBtn");
        if (saveBtn) {
          saveBtn.addEventListener("click", saveEmployee);
        }

        // 수정 버튼 이벤트 설정
        const updateBtn = document.getElementById("updateBtn");
        if (updateBtn) {
          updateBtn.addEventListener("click", updateEmployee);
        }

        // 직원 검색 모달 닫기 버튼 이벤트 설정
        const closeSearchModalBtn = document.querySelector(
          "#employeeSearchModal .modal-close"
        );
        if (closeSearchModalBtn) {
          closeSearchModalBtn.addEventListener(
            "click",
            closeEmployeeSearchModal
          );
        }
      });

      // Supabase 클라이언트가 초기화되었는지 확인
      function checkSupabaseInitialized() {
        if (!supabase) {
          console.error("Supabase 클라이언트가 초기화되지 않았습니다.");
          return false;
        }
        return true;
      }


      // 직원 목록을 불러오는 함수
      async function loadEmployeeList() {
        if (!checkSupabaseInitialized()) return [];

        try {
          // Admin API를 통해 사용자 목록 불러오기
          const { data, error } = await supabase.auth.admin.listUsers();

          if (error) {
            console.error("직원 목록 불러오기 실패:", error);
            return [];
          }

          // 사용자 데이터 가공
          const employees = data.users.map((user) => {
            // 이메일에서 @ 앞부분만 추출하여 직원번호로 사용
            const employeeId = user.email.split("@")[0];

            // all_employeesinfo에서 해당하는 직원번호를 가진 직원 정보 찾기
            let employeeName = user.user_metadata?.name || "이름 없음";

            // all_employeesinfo가 로드되었으면 거기서 직원명 가져오기
            if (all_employeesinfo && all_employeesinfo.length > 0) {
              const employeeInfo = all_employeesinfo.find(
                (emp) =>
                  String(emp.직원번호).toLowerCase() ===
                  employeeId.toLowerCase()
              );
              if (employeeInfo) {
                employeeName = employeeInfo.직원명;
              }
            }

            return {
              employeeId: employeeId,
              name: employeeName,
              password: "********", // 보안상 비밀번호는 표시하지 않음
            };
          });

          return employees;
        } catch (error) {
          console.error("직원 목록 처리 중 오류 발생:", error);
          return [];
        }
      }

      // 페이지 로드 시 직원 목록 불러오기
      async function initEmployeeList() {
        try {
          // 직원 목록 로드
          const employees = await loadEmployeeList();

          // 테이블에 직원 목록 표시
          displayEmployeesInTable(employees);
        } catch (error) {
          console.error("직원 목록 초기화 중 오류 발생:", error);
          showAlert("직원 목록을 불러오는 데 실패했습니다.");
        }
      }

      // 직원 테이블에 데이터를 표시하는 함수
      function displayEmployeesInTable(employees) {
        if (!employees || employees.length === 0) {
          console.warn("표시할 직원 데이터가 없습니다.");
          return;
        }

        const tableBody = document.getElementById("employeeTableBody");
        if (!tableBody) {
          console.error("직원 테이블 본문을 찾을 수 없습니다.");
          return;
        }

        // 직원번호 기준으로 오름차순 정렬
        employees.sort((a, b) => {
          const idA = a.employeeId.toLowerCase();
          const idB = b.employeeId.toLowerCase();
          return idA.localeCompare(idB, 'ko');
        });

        // 테이블 초기화
        tableBody.innerHTML = "";

        // 데이터를 테이블에 추가
        employees.forEach((employee) => {
          const newRow = document.createElement("tr");

          // 행에 셀 추가
          newRow.innerHTML = `
            <td>${employee.employeeId}</td>
            <td>${employee.name}</td>
            <td>${employee.password}</td>
          `;

          // 행 클릭 이벤트 추가
          newRow.addEventListener("click", function () {
            // 현재 선택된 행에서 선택 효과 제거
            const selectedRow = tableBody.querySelector(".selected-row");
            if (selectedRow) selectedRow.classList.remove("selected-row");

            // 클릭된 행에 선택 효과 추가
            this.classList.add("selected-row");

            // 직원 정보 폼에 데이터 채우기
            document.getElementById("employeeId").value = employee.employeeId;
            document.getElementById("employeeName").value = employee.name;
            document.getElementById("employeePassword").value =
              employee.password;
          });

          tableBody.appendChild(newRow);
        });
      }

      // 모달 관련 전역 함수
      function showModal(message) {
        const modalMessage = document.getElementById("modalMessage");
        const customModal = document.getElementById("customModal");
        const modalCloseBtn = document.querySelector(
          "#customModal .modal-close"
        );
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");

        if (modalMessage) modalMessage.textContent = message;

        if (customModal) {
          customModal.style.display = "flex";

          // x 버튼 이벤트 추가
          if (modalCloseBtn) {
            modalCloseBtn.addEventListener("click", closeModal);
          }

          // 확인 버튼 이벤트 추가
          if (modalConfirmBtn) {
            modalConfirmBtn.addEventListener("click", closeModal);
          }

          // ESC 키 이벤트 추가
          document.addEventListener("keydown", handleEscKeyForModal);
        }
      }

      function closeModal() {
        const customModal = document.getElementById("customModal");
        const confirmModal = document.getElementById("confirmModal");
        const modalCloseBtn = document.querySelector(
          "#customModal .modal-close"
        );
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");

        // 이벤트 리스너 제거
        if (modalCloseBtn) {
          modalCloseBtn.removeEventListener("click", closeModal);
        }

        if (modalConfirmBtn) {
          modalConfirmBtn.removeEventListener("click", closeModal);
        }

        document.removeEventListener("keydown", handleEscKeyForModal);

        // 모달 닫기
        if (customModal) customModal.style.display = "none";
        if (confirmModal) confirmModal.style.display = "none";
      }

      // ESC 키 이벤트 핸들러
      function handleEscKeyForModal(event) {
        if (event.key === "Escape") {
          closeModal();
        }
      }

      // 확인 모달 관련 함수
      function showConfirmModal(message) {
        return new Promise((resolve) => {
          const confirmModal = document.getElementById("confirmModal");
          const confirmMessage = document.getElementById("confirmModalMessage");
          const yesBtn = document.getElementById("confirmYesBtn");
          const noBtn = document.getElementById("confirmNoBtn");
          const closeBtn = confirmModal.querySelector(".modal-close");

          // 메시지 설정
          if (confirmMessage) {
            confirmMessage.textContent = message;
          }

          // 모달 표시
          if (confirmModal) {
            confirmModal.style.display = "flex";
          }

          // 이벤트 리스너 설정
          function handleYes() {
            if (confirmModal) {
              confirmModal.style.display = "none";
            }
            cleanup();
            resolve(true);
          }

          function handleNo() {
            if (confirmModal) {
              confirmModal.style.display = "none";
            }
            cleanup();
            resolve(false);
          }

          // ESC 키로 모달 닫기 - No 버튼과 동일한 동작
          function handleEscKeyForConfirmModal(event) {
            if (event.key === "Escape") {
              handleNo();
            }
          }

          function cleanup() {
            if (yesBtn) {
              yesBtn.removeEventListener("click", handleYes);
            }
            if (noBtn) {
              noBtn.removeEventListener("click", handleNo);
            }
            if (closeBtn) {
              closeBtn.removeEventListener("click", handleNo);
            }
            document.removeEventListener(
              "keydown",
              handleEscKeyForConfirmModal
            );
          }

          // 이벤트 리스너 추가
          if (yesBtn) {
            yesBtn.addEventListener("click", handleYes);
          }
          if (noBtn) {
            noBtn.addEventListener("click", handleNo);
          }
          if (closeBtn) {
            closeBtn.addEventListener("click", handleNo);
          }
          document.addEventListener("keydown", handleEscKeyForConfirmModal);
        });
      }

      // alert 대신 모달을 사용하는 함수
      function showAlert(message) {
        showModal(message);
      }

      // 로딩 표시 함수
      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }

      // 로딩 숨기기 함수
      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }

      // 직원 검색 모달 열기
      function openEmployeeSearchModal() {
        // 모달 열기
        const employeeSearchModal = document.getElementById(
          "employeeSearchModal"
        );
        if (employeeSearchModal) {
          employeeSearchModal.style.display = "flex";
        }

        // 검색 결과 표시
        displayEmployeeSearchResults(all_employeesinfo);

        // 검색 입력 필드에 포커스
        const employeeSearchInput = document.getElementById(
          "employeeSearchInput"
        );
        if (employeeSearchInput) {
          employeeSearchInput.value = "";
          employeeSearchInput.focus();
        }
      }

      // 직원 검색 모달 닫기
      function closeEmployeeSearchModal() {
        const employeeSearchModal = document.getElementById(
          "employeeSearchModal"
        );
        if (employeeSearchModal) {
          employeeSearchModal.style.display = "none";
        }
      }

      // 직원 검색 결과 필터링
      function filterEmployeeSearchResults() {
        const searchTerm = document
          .getElementById("employeeSearchInput")
          .value.toLowerCase();
        const filteredEmployees = all_employeesinfo.filter((employee) => {
          const employeeId = String(employee.직원번호).toLowerCase();
          const employeeName = employee.직원명.toLowerCase();
          return (
            employeeId.includes(searchTerm) || employeeName.includes(searchTerm)
          );
        });
        displayEmployeeSearchResults(filteredEmployees);
      }

      // 직원 검색 결과 표시
      function displayEmployeeSearchResults(employees) {
        const tableBody = document.getElementById("employeeSearchTableBody");
        if (!tableBody) return;

        // 테이블 초기화
        tableBody.innerHTML = "";

        if (!employees || employees.length === 0) {
          const newRow = document.createElement("tr");
          newRow.innerHTML = "<td colspan='2'>검색 결과가 없습니다</td>";
          tableBody.appendChild(newRow);
          return;
        }

        // 직원번호 기준으로 오름차순 정렬
        employees.sort((a, b) => {
          const idA = String(a.직원번호).toLowerCase();
          const idB = String(b.직원번호).toLowerCase();
          return idA.localeCompare(idB, 'ko');
        });

        // 검색 결과 표시
        employees.forEach((employee) => {
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
            <td>${employee.직원번호}</td>
            <td>${employee.직원명}</td>
          `;

          // 더블 클릭 이벤트
          newRow.addEventListener("dblclick", function () {
            document.getElementById("employeeId").value = employee.직원번호;
            document.getElementById("employeeName").value = employee.직원명;
            closeEmployeeSearchModal();
          });

          tableBody.appendChild(newRow);
        });
      }

      // 직원 정보 폼 초기화
      function resetEmployeeForm() {
        document.getElementById("employeeId").value = "";
        document.getElementById("employeeName").value = "";
        document.getElementById("employeePassword").value = "";
      }

      // 직원 정보 저장
      async function saveEmployee() {
        try {
          const employeeId = document.getElementById("employeeId").value.trim();
          const employeeName = document
            .getElementById("employeeName")
            .value.trim();
          const password = document.getElementById("employeePassword").value;

          // 유효성 검사
          if (!employeeId) {
            showAlert("직원번호를 입력해주세요.");
            return;
          }

          if (!employeeName) {
            showAlert("직원명을 입력해주세요.");
            return;
          }

          if (!password) {
            showAlert("비밀번호를 입력해주세요.");
            return;
          }

          // 비밀번호 길이 검사
          if (password.length < 6) {
            showAlert("비밀번호는 최소 6자리 이상이어야 합니다.");
            return;
          }

          showLoading();

          // 직원 계정 생성
          const result = await createEmployeeAccount(employeeId, password);

          if (!result.success) {
            hideLoading();
            showAlert(`계정 생성 실패: ${result.message}`);
            return;
          }

          // 직원 목록 다시 로드
          const employees = await loadEmployeeList();
          displayEmployeesInTable(employees);

          hideLoading();
          showAlert("직원 계정이 성공적으로 생성되었습니다.");

          // 폼 초기화
          resetEmployeeForm();
        } catch (error) {
          hideLoading();
          console.error("직원 저장 중 오류 발생:", error);
          showAlert("직원 저장 중 오류가 발생했습니다.");
        }
      }

      // 직원 정보 수정
      async function updateEmployee() {
        try {
          const employeeId = document.getElementById("employeeId").value.trim();
          const password = document.getElementById("employeePassword").value;

          // 유효성 검사
          if (!employeeId) {
            showAlert("직원번호를 입력해주세요.");
            return;
          }

          if (!password) {
            showAlert("변경할 비밀번호를 입력해주세요.");
            return;
          }

          // 비밀번호 길이 검사
          if (password.length < 6) {
            showAlert("비밀번호는 최소 6자리 이상이어야 합니다.");
            return;
          }

          // 수정 전에 확인
          const confirmed = await showConfirmModal(
            "비밀번호를 변경하시겠습니까?"
          );
          if (!confirmed) return;

          showLoading();

          // 직원 비밀번호 수정
          const result = await updateEmployeePassword(employeeId, password);

          hideLoading();

          if (!result.success) {
            showAlert(`비밀번호 수정 실패: ${result.message}`);
            return;
          }

          showAlert("비밀번호가 성공적으로 변경되었습니다.");
        } catch (error) {
          hideLoading();
          console.error("직원 정보 수정 중 오류 발생:", error);
          showAlert("직원 정보 수정 중 오류가 발생했습니다.");
        }
      }

      // 직원 정보 삭제
      async function deleteEmployee() {
        try {
          const employeeId = document.getElementById("employeeId").value.trim();

          // 유효성 검사
          if (!employeeId) {
            showAlert("삭제할 직원번호를 입력해주세요.");
            return;
          }

          // 삭제 전에 확인
          const confirmed = await showConfirmModal(
            "정말로 이 직원 계정을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다."
          );
          if (!confirmed) return;

          showLoading();

          // 직원 계정 삭제
          const result = await deleteEmployeeAccount(employeeId);

          if (!result.success) {
            hideLoading();
            showAlert(`계정 삭제 실패: ${result.message}`);
            return;
          }

          // 직원 목록 다시 로드
          const employees = await loadEmployeeList();
          displayEmployeesInTable(employees);

          hideLoading();
          showAlert("직원 계정이 성공적으로 삭제되었습니다.");

          // 폼 초기화
          resetEmployeeForm();
        } catch (error) {
          hideLoading();
          console.error("직원 삭제 중 오류 발생:", error);
          showAlert("직원 삭제 중 오류가 발생했습니다.");
        }
      }
    </script>
  </body>
</html>
