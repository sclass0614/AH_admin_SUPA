<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>직원 관리 정보</title>
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="supabase.js"></script>
    <script src="auth.js"></script>
    
  </head>
  <body>
    <div id="loadingOverlay">
      <div class="loader"></div>
      <div>데이터를 처리중입니다...</div>
    </div>

    <div class="container">
      <div class="header" id="headerSection">
        <div class="title" id="pageTitle">
          우리집 데이케어 센터 관리자모드_PW부여
        </div>
      </div>

      <div class="content-wrapper" id="contentArea">
        <div class="employee-list" id="employeeListContainer">
          <h3 class="employee-list-title" id="employeeListTitle">직원 목록</h3>
          <div class="table-container">
            <table id="employeeTable">
              <thead>
                <tr>
                  <th class="employee-column">직원번호</th>
                  <th class="employee-column">직원명</th>
                  <th class="employee-column">비밀번호</th>
                </tr>
              </thead>
              <tbody id="employeeTableBody">
              </tbody>
            </table>
          </div>
        </div>

        <div class="employee-form" id="employeeFormContainer">
          <h3>직원 정보</h3>
          <form id="employeeForm" onsubmit="return false;">
            <div class="employee-info-container">
              <div class="form-row">
                <div class="form-group">
                  <label for="employeeId">직원번호</label>
                  <div class="input-with-button">
                    <input type="text" id="employeeId" name="employeeId" readonly />
                    <button type="button" id="searchEmployeeBtn">검색</button>
                  </div>
                </div>
                <div class="form-group">
                  <label for="employeeName">직원명</label>
                  <input type="text" id="employeeName" name="employeeName" />
                </div>
              </div>
              <div class="form-group">
                <label for="employeePassword">비밀번호</label>
                <input
                  type="password"
                  id="employeePassword"
                  name="employeePassword"
                  minlength="6"
                  placeholder="비밀번호는 최소 6자리 이상"
                />
                <div class="password-hint">
                  * 비밀번호는 최소 6자리 이상 입력해주세요
                </div>
              </div>
            </div>

            <div class="access-permissions-container">
              <div class="permissions-header">
                <h4>접근 권한 관리</h4>
                <button type="button" id="toggleAllPermissionsBtn" class="toggle-all-btn">전체 선택</button>
              </div>
              <div class="permissions-grid" id="permissionsGrid">
              </div>
            </div>

            <div class="form-buttons-container">
              <button type="button" id="saveBtn">저장</button>
              <button type="button" id="updateBtn">수정</button>
              <button type="button" id="deleteBtn">삭제</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="customModal">
      <div class="modal-container">
        <div class="modal-header">
          <div class="modal-title">알림</div>
          <div class="modal-close">&times;</div>
        </div>
        <div class="modal-body" id="modalMessage">
        </div>
        <div class="modal-footer">
          <button class="modal-btn" id="modalConfirmBtn">확인</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
      <div class="modal-container">
        <div class="modal-header">
          <div class="modal-title">확인</div>
          <div class="modal-close">&times;</div>
        </div>
        <div class="modal-body" id="confirmModalMessage">
        </div>
        <div class="modal-footer">
          <button class="modal-btn" id="confirmYesBtn">확인</button>
          <button class="modal-btn cancel-btn" id="confirmNoBtn">취소</button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="employeeSearchModal">
      <div class="modal-container search-modal-container">
        <div class="modal-header">
          <div class="modal-title">직원 검색</div>
          <div class="modal-close">&times;</div>
        </div>
        <div class="modal-body">
          <div class="search-box">
            <input
              type="text"
              id="employeeSearchInput"
              placeholder="직원번호 또는 이름 검색"
            />
          </div>
          <div class="search-results">
            <table id="employeeSearchTable">
              <thead>
                <tr>
                  <th>직원번호</th>
                  <th>직원명</th>
                </tr>
              </thead>
              <tbody id="employeeSearchTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let all_employeesinfo = null;
      let all_setting_data = null;

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          showLoading();
          all_employeesinfo = await getEmployeesInfo();
          all_setting_data = await getAllSettingTableData();

          await initEmployeeList();
          initPermissionsGrid();
          resetEmployeeForm();

          hideLoading();
        } catch (error) {
          console.error("데이터 로드 중 오류:", error);
          hideLoading();
          showAlert("데이터 로드에 실패했습니다.");
        }

        const searchEmployeeBtn = document.getElementById("searchEmployeeBtn");
        if (searchEmployeeBtn) {
          searchEmployeeBtn.addEventListener("click", openEmployeeSearchModal);
        }

        const employeeSearchInput = document.getElementById(
          "employeeSearchInput"
        );
        if (employeeSearchInput) {
          employeeSearchInput.addEventListener(
            "input",
            filterEmployeeSearchResults
          );
        }

        const saveBtn = document.getElementById("saveBtn");
        if (saveBtn) {
          saveBtn.onclick = function(e) {
            e.preventDefault();
            saveEmployee();
          };
        }

        const updateBtn = document.getElementById("updateBtn");
        if (updateBtn) {
          updateBtn.onclick = function(e) {
            e.preventDefault();
            updateEmployee();
          };
        }

        const deleteBtn = document.getElementById("deleteBtn");
        if (deleteBtn) {
          deleteBtn.onclick = function(e) {
            e.preventDefault();
            deleteEmployee();
          };
        }

        const closeSearchModalBtn = document.querySelector(
          "#employeeSearchModal .modal-close"
        );
        if (closeSearchModalBtn) {
          closeSearchModalBtn.addEventListener(
            "click",
            closeEmployeeSearchModal
          );
        }

        const toggleAllPermissionsBtn = document.getElementById("toggleAllPermissionsBtn");
        if (toggleAllPermissionsBtn) {
          toggleAllPermissionsBtn.addEventListener("click", toggleAllPermissions);
        }
      });

      function checkSupabaseInitialized() {
        if (!supabase) {
          console.error("Supabase 클라이언트가 초기화되지 않았습니다.");
          return false;
        }
        return true;
      }

      async function loadEmployeeList() {
        if (!checkSupabaseInitialized()) return [];

        try {
          const { data, error } = await supabase.auth.admin.listUsers();

          if (error) {
            console.error("직원 목록 불러오기 실패:", error);
            return [];
          }

          const employees = data.users.map((user) => {
            const employeeId = user.email.split("@")[0];

            let employeeName = user.user_metadata?.name || "이름 없음";

            if (all_employeesinfo && all_employeesinfo.length > 0) {
              const employeeInfo = all_employeesinfo.find(
                (emp) =>
                  String(emp.직원번호).toLowerCase() ===
                  employeeId.toLowerCase()
              );
              if (employeeInfo) {
                employeeName = employeeInfo.직원명;
              }
            }

            return {
              employeeId: employeeId,
              name: employeeName,
              password: "********",
            };
          });

          return employees;
        } catch (error) {
          console.error("직원 목록 처리 중 오류 발생:", error);
          return [];
        }
      }

      async function initEmployeeList() {
        try {
          const employees = await loadEmployeeList();
          displayEmployeesInTable(employees);
        } catch (error) {
          console.error("직원 목록 초기화 중 오류 발생:", error);
          showAlert("직원 목록을 불러오는 데 실패했습니다.");
        }
      }

      function displayEmployeesInTable(employees) {
        if (!employees || employees.length === 0) {
          console.warn("표시할 직원 데이터가 없습니다.");
          return;
        }

        const tableBody = document.getElementById("employeeTableBody");
        if (!tableBody) {
          console.error("직원 테이블 본문을 찾을 수 없습니다.");
          return;
        }

        employees.sort((a, b) => {
          const idA = a.employeeId.toLowerCase();
          const idB = b.employeeId.toLowerCase();
          return idA.localeCompare(idB, 'ko');
        });

        tableBody.innerHTML = "";

        employees.forEach((employee) => {
          const newRow = document.createElement("tr");

          newRow.innerHTML = `
            <td>${employee.employeeId}</td>
            <td>${employee.name}</td>
            <td>${employee.password}</td>
          `;

          newRow.addEventListener("click", async function () {
            const selectedRow = tableBody.querySelector(".selected-row");
            if (selectedRow) selectedRow.classList.remove("selected-row");

            this.classList.add("selected-row");

            document.getElementById("employeeId").value = employee.employeeId;
            document.getElementById("employeeName").value = employee.name;
            document.getElementById("employeePassword").value =
              employee.password;

            await loadEmployeePermissions(employee.employeeId);
          });

          tableBody.appendChild(newRow);
        });
      }

      function showModal(message) {
        const modalMessage = document.getElementById("modalMessage");
        const customModal = document.getElementById("customModal");
        const modalCloseBtn = document.querySelector(
          "#customModal .modal-close"
        );
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");

        if (modalMessage) modalMessage.textContent = message;

        if (customModal) {
          customModal.style.display = "flex";

          if (modalCloseBtn) {
            modalCloseBtn.addEventListener("click", closeModal);
          }

          if (modalConfirmBtn) {
            modalConfirmBtn.addEventListener("click", closeModal);
          }

          document.addEventListener("keydown", handleEscKeyForModal);
        }
      }

      function closeModal() {
        const customModal = document.getElementById("customModal");
        const confirmModal = document.getElementById("confirmModal");
        const modalCloseBtn = document.querySelector(
          "#customModal .modal-close"
        );
        const modalConfirmBtn = document.getElementById("modalConfirmBtn");

        if (modalCloseBtn) {
          modalCloseBtn.removeEventListener("click", closeModal);
        }

        if (modalConfirmBtn) {
          modalConfirmBtn.removeEventListener("click", closeModal);
        }

        document.removeEventListener("keydown", handleEscKeyForModal);

        if (customModal) customModal.style.display = "none";
        if (confirmModal) confirmModal.style.display = "none";
      }

      function handleEscKeyForModal(event) {
        if (event.key === "Escape") {
          closeModal();
        }
      }

      function showConfirmModal(message) {
        return new Promise((resolve) => {
          const confirmModal = document.getElementById("confirmModal");
          const confirmMessage = document.getElementById("confirmModalMessage");
          const yesBtn = document.getElementById("confirmYesBtn");
          const noBtn = document.getElementById("confirmNoBtn");
          const closeBtn = confirmModal.querySelector(".modal-close");

          if (confirmMessage) {
            confirmMessage.textContent = message;
          }

          if (confirmModal) {
            confirmModal.style.display = "flex";
          }

          function handleYes() {
            if (confirmModal) {
              confirmModal.style.display = "none";
            }
            cleanup();
            resolve(true);
          }

          function handleNo() {
            if (confirmModal) {
              confirmModal.style.display = "none";
            }
            cleanup();
            resolve(false);
          }

          function handleEscKeyForConfirmModal(event) {
            if (event.key === "Escape") {
              handleNo();
            }
          }

          function cleanup() {
            if (yesBtn) {
              yesBtn.removeEventListener("click", handleYes);
            }
            if (noBtn) {
              noBtn.removeEventListener("click", handleNo);
            }
            if (closeBtn) {
              closeBtn.removeEventListener("click", handleNo);
            }
            document.removeEventListener(
              "keydown",
              handleEscKeyForConfirmModal
            );
          }

          if (yesBtn) {
            yesBtn.addEventListener("click", handleYes);
          }
          if (noBtn) {
            noBtn.addEventListener("click", handleNo);
          }
          if (closeBtn) {
            closeBtn.addEventListener("click", handleNo);
          }
          document.addEventListener("keydown", handleEscKeyForConfirmModal);
        });
      }

      function showAlert(message) {
        showModal(message);
      }

      function showLoading() {
        document.getElementById("loadingOverlay").style.display = "flex";
      }

      function hideLoading() {
        document.getElementById("loadingOverlay").style.display = "none";
      }

      function openEmployeeSearchModal() {
        const employeeSearchModal = document.getElementById(
          "employeeSearchModal"
        );
        if (employeeSearchModal) {
          employeeSearchModal.style.display = "flex";
        }

        displayEmployeeSearchResults(all_employeesinfo);

        const employeeSearchInput = document.getElementById(
          "employeeSearchInput"
        );
        if (employeeSearchInput) {
          employeeSearchInput.value = "";
          employeeSearchInput.focus();
        }
      }

      function closeEmployeeSearchModal() {
        const employeeSearchModal = document.getElementById(
          "employeeSearchModal"
        );
        if (employeeSearchModal) {
          employeeSearchModal.style.display = "none";
        }
      }

      function filterEmployeeSearchResults() {
        const searchTerm = document
          .getElementById("employeeSearchInput")
          .value.toLowerCase();
        const filteredEmployees = all_employeesinfo.filter((employee) => {
          const employeeId = String(employee.직원번호).toLowerCase();
          const employeeName = employee.직원명.toLowerCase();
          return (
            employeeId.includes(searchTerm) || employeeName.includes(searchTerm)
          );
        });
        displayEmployeeSearchResults(filteredEmployees);
      }

      function displayEmployeeSearchResults(employees) {
        const tableBody = document.getElementById("employeeSearchTableBody");
        if (!tableBody) return;

        tableBody.innerHTML = "";

        if (!employees || employees.length === 0) {
          const newRow = document.createElement("tr");
          newRow.innerHTML = "<td colspan='2'>검색 결과가 없습니다</td>";
          tableBody.appendChild(newRow);
          return;
        }

        employees.sort((a, b) => {
          const idA = String(a.직원번호).toLowerCase();
          const idB = String(b.직원번호).toLowerCase();
          return idA.localeCompare(idB, 'ko');
        });

        employees.forEach((employee) => {
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
            <td>${employee.직원번호}</td>
            <td>${employee.직원명}</td>
          `;

          newRow.addEventListener("dblclick", async function () {
            document.getElementById("employeeId").value = employee.직원번호;
            document.getElementById("employeeName").value = employee.직원명;
            closeEmployeeSearchModal();
            
            await loadEmployeePermissions(employee.직원번호);
          });

          tableBody.appendChild(newRow);
        });
      }

      function initPermissionsGrid() {
        const permissionsGrid = document.getElementById("permissionsGrid");
        if (!permissionsGrid || !all_setting_data) return;

        permissionsGrid.innerHTML = "";

        all_setting_data.forEach((item, index) => {
          const permissionItem = document.createElement("div");
          permissionItem.className = "permission-item";
          
          const checkboxId = `permission_${index}`;
          
          permissionItem.innerHTML = `
            <input type="checkbox" id="${checkboxId}" data-category-order="${item.카테고리순서}" data-work-type="${item.업무구분}" data-url="${item.연결주소 || ''}">
            <label for="${checkboxId}">
              <div class="permission-category">${item.카테고리}</div>
              <div class="permission-name">${item.업무구분}</div>
            </label>
          `;
          
          permissionsGrid.appendChild(permissionItem);
        });
      }

      async function loadEmployeePermissions(employeeId) {
        if (!employeeId) return;

        try {
          const permissions = await getEmployeeAccessPermissions(employeeId);
          
          const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]');
          checkboxes.forEach(checkbox => {
            checkbox.checked = false;
          });

          permissions.forEach(permission => {
            const checkbox = document.querySelector(`#permissionsGrid input[data-category-order="${permission.카테고리순서}"][data-work-type="${permission.업무구분}"]`);
            if (checkbox) {
              checkbox.checked = true;
            }
          });
        } catch (error) {
          console.error("직원 권한 로드 중 오류:", error);
        }
      }

      function getSelectedPermissions(employeeId) {
        const selectedPermissions = [];
        const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]:checked');
        
        checkboxes.forEach(checkbox => {
          selectedPermissions.push({
            직원번호: employeeId,
            카테고리순서: checkbox.getAttribute('data-category-order'),
            업무구분: checkbox.getAttribute('data-work-type'),
            연결주소: checkbox.getAttribute('data-url')
          });
        });
        
        return selectedPermissions;
      }

      function toggleAllPermissions() {
        const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]');
        const isChecked = document.getElementById('toggleAllPermissionsBtn').textContent === '전체 선택';

        checkboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });

        document.getElementById('toggleAllPermissionsBtn').textContent = isChecked ? '전체 해지' : '전체 선택';
      }

      function resetEmployeeForm() {
        document.getElementById("employeeId").value = "";
        document.getElementById("employeeName").value = "";
        document.getElementById("employeePassword").value = "";
        
        const checkboxes = document.querySelectorAll('#permissionsGrid input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          checkbox.checked = false;
        });
      }

      async function checkEmployeeExistsInList(employeeId) {
        if (!employeeId) return false;
        
        try {
          const employees = await loadEmployeeList();
          return employees.some(emp => emp.employeeId.toLowerCase() === employeeId.toLowerCase());
        } catch (error) {
          console.error("직원 존재 여부 확인 중 오류:", error);
          return false;
        }
      }

      async function saveEmployee() {
        try {
          const employeeId = document.getElementById("employeeId").value.trim();
          const employeeName = document
            .getElementById("employeeName")
            .value.trim();
          const password = document.getElementById("employeePassword").value;

          if (!employeeId) {
            showAlert("직원번호를 입력해주세요.");
            return;
          }

          if (!employeeName) {
            showAlert("직원명을 입력해주세요.");
            return;
          }

          if (!password) {
            showAlert("비밀번호를 입력해주세요.");
            return;
          }

          if (password.length < 6) {
            showAlert("비밀번호는 최소 6자리 이상이어야 합니다.");
            return;
          }

          const employeeExists = await checkEmployeeExistsInList(employeeId);
          if (employeeExists) {
            showAlert("이미 존재하는 직원번호입니다. 다른 직원번호를 사용해주세요.");
            return;
          }

          showLoading();

          const result = await createEmployeeAccount(employeeId, password);

          if (!result.success) {
            hideLoading();
            showAlert(`계정 생성 실패: ${result.message}`);
            return;
          }

          const selectedPermissions = getSelectedPermissions(employeeId);
          if (selectedPermissions.length > 0) {
            const permissionResult = await saveEmployeeAccessPermissions(employeeId, selectedPermissions);
            if (!permissionResult.success) {
              console.warn("접근 권한 저장 실패:", permissionResult.message);
            }
          }

          const employees = await loadEmployeeList();
          displayEmployeesInTable(employees);

          hideLoading();
          showAlert("직원 계정이 성공적으로 생성되었습니다.");

          resetEmployeeForm();
        } catch (error) {
          hideLoading();
          console.error("직원 저장 중 오류 발생:", error);
          showAlert("직원 저장 중 오류가 발생했습니다.");
        }
      }

      async function updateEmployee() {
        try {
          const employeeId = document.getElementById("employeeId").value.trim();
          const password = document.getElementById("employeePassword").value;

          if (!employeeId) {
            showAlert("직원번호를 입력해주세요.");
            return;
          }

          if (!password) {
            showAlert("변경할 비밀번호를 입력해주세요.");
            return;
          }

          if (password.length < 6) {
            showAlert("비밀번호는 최소 6자리 이상이어야 합니다.");
            return;
          }

          const employeeExists = await checkEmployeeExistsInList(employeeId);
          if (!employeeExists) {
            showAlert("존재하지 않는 직원번호입니다. 올바른 직원번호를 입력해주세요.");
            return;
          }

          const confirmed = await showConfirmModal(
            "비밀번호와 접근 권한을 변경하시겠습니까?"
          );
          if (!confirmed) return;

          showLoading();

          const result = await updateEmployeePassword(employeeId, password);

          if (!result.success) {
            hideLoading();
            showAlert(`비밀번호 수정 실패: ${result.message}`);
            return;
          }

          const selectedPermissions = getSelectedPermissions(employeeId);
          const permissionResult = await updateEmployeeAccessPermissions(employeeId, selectedPermissions);
          
          if (!permissionResult.success) {
            console.warn("접근 권한 수정 실패:", permissionResult.message);
          }

          hideLoading();
          showAlert("비밀번호와 접근 권한이 성공적으로 변경되었습니다.");
        } catch (error) {
          hideLoading();
          console.error("직원 정보 수정 중 오류 발생:", error);
          showAlert("직원 정보 수정 중 오류가 발생했습니다.");
        }
      }

      async function deleteEmployee() {
        try {
          const employeeId = document.getElementById("employeeId").value.trim();

          if (!employeeId) {
            showAlert("삭제할 직원번호를 입력해주세요.");
            return;
          }

          const employeeExists = await checkEmployeeExistsInList(employeeId);
          if (!employeeExists) {
            showAlert("존재하지 않는 직원번호입니다. 올바른 직원번호를 입력해주세요.");
            return;
          }

          const confirmed = await showConfirmModal(
            "정말로 이 직원 계정과 접근 권한을 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다."
          );
          if (!confirmed) return;

          showLoading();

          const result = await deleteEmployeeAccount(employeeId);

          if (!result.success) {
            hideLoading();
            showAlert(`계정 삭제 실패: ${result.message}`);
            return;
          }

          const permissionResult = await deleteEmployeeAccessPermissions(employeeId);
          if (!permissionResult.success) {
            console.warn("접근 권한 삭제 실패:", permissionResult.message);
          }

          const employees = await loadEmployeeList();
          displayEmployeesInTable(employees);

          hideLoading();
          showAlert("직원 계정과 접근 권한이 성공적으로 삭제되었습니다.");

          resetEmployeeForm();
        } catch (error) {
          hideLoading();
          console.error("직원 삭제 중 오류 발생:", error);
          showAlert("직원 삭제 중 오류가 발생했습니다.");
        }
      }
    </script>
  </body>
</html>